<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />

  <title>Pyxcel</title>
  <meta content="" name="description" />
  <meta content="" name="keywords" />
  <script src="https://kit.fontawesome.com/e1004dd04e.js" crossorigin="anonymous"></script>
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
    rel="stylesheet" />

  <!-- Vendor CSS Files -->
  <link href="../assets/vendor/animate.css/animate.min.css" rel="stylesheet" />
  <link href="../assets/vendor/aos/aos.css" rel="stylesheet" />
  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
  <link href="../assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet" />
  <link href="../assets/vendor/remixicon/remixicon.css" rel="stylesheet" />
  <link href="../assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />

  <link href="../assets/css/styles.css" rel="stylesheet" />
  <link href="../assets/css/style.css" rel="stylesheet" />
  <link href="../assets/css/styles-contenido.css" rel="stylesheet" />
  <link rel="stylesheet" href="../assets/css/estilosDialogEvaluacion.css" />

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
</head>

<body>
  <header id="header" class="fixed-top">
    <div class="container d-flex align-items-center">
      <h1 class="logo me-auto"><a href="../index.html">Pyxcel</a></h1>
      <!-- Uncomment below if you prefer to use an image logo -->
      <!-- <a href="index.html" class="logo me-auto"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->

      <nav id="navbar" class="navbar order-last order-lg-0">
        <ul>
          <li><a href="../index.html">Inicio</a></li>
          <li><a href="../index.html#about">Nosotros</a></li>
          <li><a class="active" href="nivel.html">Ver Curso</a></li>
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav>
      <!-- .navbar -->
      <div class="desplegable">
        <button class="desplebutton">
          <a href="#l" id="prueba" class="get-started-btn">
            cargando...
            <i class="fas fa-chevron-down"></i>
          </a>
        </button>
        <!-- <i class="material-icons">expand_more </i>  -->
        <div class="options">
          <a href="#" id="logout">Cerrar Sesion</a>
        </div>
      </div>
    </div>
  </header>
  <!-- End Header -->
  <!-- End Header -->

  <main class="main-pagina-contenido">
    <aside class="barra-menu">
      <h1>Temario</h1>
      <div class="poner-titulo-nivel">
        <template class="template-titulo-nivel">
          <h2>Nombre del Nivel</h2>
        </template>
      </div>
      <ul class="lista-temas">
        <template class="template-tema-nivel">
          <li class="tema-del-nivel"></li>
        </template>
      </ul>
      <div class="text-center">
        <button disabled="true" type="button" class="btn btn-danger btn-lg" data-toggle="modal"
          data-target="#modal_evaluacion" data-whatever="@mdo" id="rendirExamen" data-backdrop="static"
          data-keyboard="false">
          Rendir Examen</button><br /><br />
        <a href="nivel.html" type="button" class="btn btn-outline-success">Volver al Curso</a><br /><br />
      </div>
    </aside>
    <!--   barra-menu   -->
    <div class="contenidoTema-botones">
      <div class="seccion-contenido">
        <div class="titulo-del-contenido">
          <h1></h1>
        </div>

        <div class="informacion-contenido"></div>
      </div>
      <!--   seccion-contenido  -->

      <div class="seccion-botones">
        <div class="seccion-boton-anterior">
          <button class="boton-niveles boton-anterior oculto">Anterior Tema</button>
        </div>
        <div class="seccion-boton-siguiente">
          <button class="boton-niveles boton-siguiente oculto">
            Siguiente Tema
          </button>
        </div>
      </div>
      <!-- seccion-botones -->
    </div>

    <!--modal aprobado-->
    <div class="modal fade" id="modal_aprobado" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="exampleModalLabel">
              Resultado de la prueba
            </h5>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-4">
                <img src="../assets/img/aprobado.png" alt="" width="100px" />
              </div>
              <div class="col-8">
                <div class="row">
                  <h1 class="text-success">Aprobado</h1>
                </div>
                <div class="row">
                  <h3 id="nota_evaluacion1" class="text-dark"></h3>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="botonsiguientenivel" type="button" class="btn btn-success btn-lg btn-block"
              data-bs-dismiss="modal">
              Siguiente Nivel
            </button>
          </div>
        </div>
      </div>
    </div>
    <!--modal Reprobado-->
    <div class="modal fade" id="modal_reprobado" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="exampleModalLabel">
              Resultado de la prueba
            </h5>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-4">
                <img src="../assets/img/reprobado.png" alt="" width="100px" />
              </div>
              <div class="col-8">
                <div class="row">
                  <h1 class="text-danger">Reprobado</h1>
                </div>
                <div class="row">
                  <h3 id="nota_evaluacion2" class="text-dark"></h3>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger btn-lg btn-block" data-bs-dismiss="modal"
              id="botonCerrarReprobado">
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>
    <!--Modal Evaluacion-->
    <div class="modal fade" id="modal_evaluacion" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
      aria-hidden="true">
      <div class="modal-dialog " role="document">
        <div class="modal-content">

          <div class="modal-header bg-success">

            <div class="col-10 well p-1 text-white">
              <h4 id="tituloNivelLabel"> titulo</h4>
            </div>

            <div class="col-2 well p-1">
              <h5 id="temporizador" class="font-weight-bold text-white p-1 text-center" style="background-color: rgba(255, 0, 0, 0.5);
                border-radius: 7px;"></h5>
            </div>

          </div>
          <div class="flexContainerpr container5pr">
            <div class="flexItempr item1pr" id="TituloPregunta">item1</div>
          </div>
          <div class="modal-body">
            <div class="container-fluid">

              <div class="row p-1" style="display: flex; align-items: center; margin-top: -20px;">
                <label id="o1pregunta" type="button" class="btn btn-dark"
                  style="white-space: normal; margin-bottom: 5px">Cargando...</label>
                <label id="o2pregunta" type="button" class="btn btn-dark"
                  style="white-space: normal; margin-bottom: 5px">Cargando...</label>
                <label id="o3pregunta" type="button" class="btn btn-dark"
                  style="white-space: normal; margin-bottom: 5px">Cargando...</label>
                <label id="o4pregunta" type="button" class="btn btn-dark"
                  style="white-space: normal; margin-bottom: 1px">Cargando...</label>
              </div>

            </div>
          </div>
          <div class="modal-footer">
            
            <button type="button" id="botonCancelarPrueba" class="btn btn-danger">
              cancelar prueba
            </button>
            <!--button
                id="botonOmitirDialog"
                type="button"
                class="btn btn-warning"
              >
                omitir pregunta
              </button>-->
            <button type="button" id="close-modal" data-dismiss="modal" style="display: none"></button>
          </div>
          <p id="contadorPreguntas" style="margin-left: 20px; color: rgb(0, 145, 55);"></p>
          <div class="progress" style="height: 5px;">
            <div id="bar" class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100"
              aria-valuemin="0" aria-valuemax="100"></div>
          </div>

        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script type="module">
      //CODIGO DE RECUPERACION DEL USUARIO
      import {
        initializeApp,
        onLog,
      } from "https://www.gstatic.com/firebasejs/9.4.0/firebase-app.js";
      import {
        getAuth,
        signOut,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
      } from "https:www.gstatic.com/firebasejs/9.4.0/firebase-auth.js";
      //import { getDatabase} from "./connection-firebase";
      import {
        getDatabase,
        ref,
        get,
        set,
        child,
        update,
        remove,
        onChildAdded,
        onChildChanged,
        onChildRemoved,
      } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-database.js";
      import { incializar } from "../assets/js/scrip.js";
      const firebaseConfig = {
        apiKey: "AIzaSyAd6JDsbBWEBv_UFCpgNi9zKEjqgiGytTE",
        authDomain: "pyxcel-d6df9.firebaseapp.com",
        databaseURL: "https://pyxcel-d6df9-default-rtdb.firebaseio.com",
        projectId: "pyxcel-d6df9",
        storageBucket: "pyxcel-d6df9.appspot.com",
        messagingSenderId: "953396754317",
        appId: "1:953396754317:web:321620a07c7577f5eb6fc4",
        measurementId: "G-46CQF62KX4",
      };
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      onAuthStateChanged(auth, (user) => {
        if (user) {
          const dbref = ref(getDatabase());
          get(child(dbref, "Usuarios/" + user.uid))
            .then((snapshot) => {
              console.log(user);
              if (snapshot.exists()) {
                let text = document.getElementById("prueba");
                text.innerHTML =
                  snapshot.val().nombre +
                  '<i class="fas fa-chevron-down"></i>';
                inicializarEvaluaciones(snapshot.val(), user.uid);
                console.log("userID: "+user.uid);
                incializar();
              } else {
                console.log("No se encontro el elemento");
              }
            })
            .catch((error) => {
              console.log("unsucessfull, error" + error);
            });
        } else {
          // User is signed out
          console.log("me sali karen :D");
          window.location.href = "/index.html";
          // ...
        }

        const cont = document.getElementById("logout");

        cont.addEventListener("click", (e) => {
          signOut(auth);
        });
      });

      function inicializarEvaluaciones(datosUsuario, userid) {
        let listaPreguntas = new Array();
        const nivelActual = getParameterByName("id");

        function getParameterByName(name) {
          name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
          var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
          return results === null
            ? ""
            : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        if(nivelActual.length>0){
          get(child(ref(getDatabase()), "Evaluaciones/" + nivelActual)).then((snapshot) => {
          if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
              const childData = childSnapshot.val();
              listaPreguntas.push(childData);
            });
            if(listaPreguntas.length>0){
              inicializarFuncionamiento(datosUsuario, userid, listaPreguntas, nivelActual);
            }
          }
        })
          .catch((error) => {
            alert("unsucessfull, error" + error);
          });
        }else{
          alert("Nivel inexistente");
        }
      }

      function inicializarFuncionamiento(datosUsuario, userid, listaPreguntas, idNivelActual) {
        let indicePregunta = 0;
        let notaActual = 0;

        console.log("preguntas nivel:")
        console.log(listaPreguntas);

        const db = getDatabase();
        const commentsRef = ref(db, "Evaluaciones/" + idNivelActual);
        let textoCuenta = document.getElementById("temporizador");
        let op1pr = document.getElementById("o1pregunta");
        let op2pr = document.getElementById("o2pregunta");
        let op3pr = document.getElementById("o3pregunta");
        let op4pr = document.getElementById("o4pregunta");
        let tiPr = document.getElementById("TituloPregunta");
        let nuPr = document.getElementById("numeroPregunta");
        let tiNi = document.getElementById("tituloNivelLabel");
        let btnCeRe = document.getElementById("botonCerrarReprobado");
        let botonSigLevel = document.getElementById("botonsiguientenivel");

        let contadorPreguntas = document.getElementById("contadorPreguntas");

        var cronometro;
        var segundos;
        function iniciarTemporizador() {
          segundos = 60;
          textoCuenta.textContent = String(segundos);
          clearInterval(cronometro);
          cronometro = setInterval(function () {
            segundos = segundos - 1;
            textoCuenta.textContent = String(segundos);
            if (segundos === 0) {
              clearInterval(cronometro);
              indicePregunta = indicePregunta + 1;
              siguientePregunta();
            }
          }, 1000);
        }

        btnCeRe.addEventListener("click", function () {
          notaActual = 0;
          indicePregunta = 0;
        });
        botonSigLevel.addEventListener("click", function () {
          window.location.href = "nivel.html";
        });

        op1pr.addEventListener("click", function () {
          verificarRespuestaPregunta(op1pr.textContent, "o1pregunta");
        });

        op2pr.addEventListener("click", function () {
          verificarRespuestaPregunta(op2pr.textContent, "o2pregunta");
        });
        op3pr.addEventListener("click", function () {
          verificarRespuestaPregunta(op3pr.textContent, "o3pregunta");
        });
        op4pr.addEventListener("click", function () {
          verificarRespuestaPregunta(op4pr.textContent, "o4pregunta");
        });

        let botonRendirExamen = document.getElementById("rendirExamen");
        botonRendirExamen.addEventListener("click", function () {
          siguientePregunta();
        });

        let botonCancelar = document.getElementById("botonCancelarPrueba");
          botonCancelar.addEventListener("click", function () {
            Swal.fire({
              title: "Realmente desea salir de la evaluacion?",
              showCancelButton: true,
              confirmButtonText: "si salir",
              cancelButtonText: "cancelar",
            }).then((result) => {
              if (result.isConfirmed) {
                $("#modal_evaluacion").modal().hide();
                $("body").removeClass("modal-open");
                $(".modal-backdrop").remove();
                document.getElementById("close-modal").click();
                notaActual = 0;
                indicePregunta = 0;
              } else {
                iniciarTemporizador();
              }
            });
          });

        recuperarTituloNivel();
        verificarNotaUsuario();

        

        //metodos
        function verificarNotaUsuario(){
          if (datosUsuario["notanivel" + idNivelActual] === undefined ||datosUsuario["notanivel" + idNivelActual] === null) {
            botonRendirExamen.disabled = false;
          } else {
            botonRendirExamen.textContent = "Nota: " + datosUsuario["notanivel" + idNivelActual] + "/100";
            botonRendirExamen.disabled = true;
          }

        }
        function verificarRespuestaPregunta(respuestaActual, id_button) {
          let elem = document.getElementById(id_button);
          let preguntaActual = listaPreguntas[indicePregunta];
          if (preguntaActual.respuesta === respuestaActual) {
            notaActual = notaActual + (100 / listaPreguntas.length);
            elem.className = "btn btn-sucess";
            console.log("Respuesta correcta, tu nora es: " + notaActual);
          } else {
            console.log("Respuesta errónea, tu nota es: " + notaActual);
            elem.className = "btn btn-danger";
          }
          indicePregunta = indicePregunta + 1;
          setTimeout(siguientePregunta, 200);
        }

        function siguientePregunta() {
          quitar_animacion_botones();
          if (indicePregunta < listaPreguntas.length) {
            contadorPreguntas.textContent = (indicePregunta+1)+"/"+listaPreguntas.length;
            iniciarTemporizador();
            let pregunta = listaPreguntas[indicePregunta];
            let progreso = 100 / listaPreguntas.length;
            $('#bar').css('width', progreso + '%');
            tiPr.textContent = pregunta.pregunta;
            op1pr.textContent = pregunta.o1;
            op2pr.textContent = pregunta.o2;
            op3pr.textContent = pregunta.o3;
            op4pr.textContent = pregunta.o4;
          } else {
            mostrarNotaUsurioDialog();
          }
        }
        function quitar_animacion_botones() {
          document.getElementById("o1pregunta").className =
            "btn btn-dark";
          document.getElementById("o2pregunta").className =
            "btn btn-dark";
          document.getElementById("o3pregunta").className =
            "btn btn-dark";
          document.getElementById("o4pregunta").className =
            "btn btn-dark";
        }



        

        function mostrarNotaUsurioDialog() {
          clearInterval(cronometro);
          if (notaActual >= 50.5) {
            subirNotaBD(notaActual);
            document.getElementById("close-modal").click();
            $("#modal_aprobado").modal({
              backdrop: "static",
              keyboard: true,
              show: true,
            });
            $("#modal_aprobado").modal("show"); // abrir
            document.getElementById("nota_evaluacion1").innerHTML =
              notaActual + "/100";
            subirNotaBD(notaActual);
          } else {
            document.getElementById("close-modal").click();
            document.getElementById("nota_evaluacion2").innerHTML =
              notaActual + "/100";
            $("#modal_reprobado").modal({
              backdrop: "static",
              keyboard: true,
              show: true,
            });
            $("#modal_reprobado").modal("show"); // abrir
            document.getElementById("nota_evaluacion2").innerHTML =
              notaActual + "/100";
          }
        }

        //base de datos
        function recuperarTituloNivel() {
          const dbRef = ref(getDatabase());
          get(child(dbRef, "Niveles/" + idNivelActual + "/titulo"))
            .then((snapshot) => {
              if (snapshot.exists()) {
                let titulo = snapshot.val();
                tiNi.textContent = titulo;
              } else {
                console.log("No data available");
              }
            })
            .catch((error) => {
              console.error(error);
            });
        }

        function subirNotaBD(nota) {
            set(
              ref(
                getDatabase(),
                "Usuarios/" + userid + "/notanivel" + idNivelActual
              ),
              nota
            )
              .then(() => {
                //alert("Datos registrados correctamente");
              })
              .catch((error) => {
                //alert("unsucessfull, error" + error);
              });
          }
      }

    </script>

    <script src="../assets/js/libs/jquery.min.js" type="text/javascript"></script>
    <script type="module" src="../assets/js/recover-data.js"></script>
    <script type="module" src="../assets/js/scrip.js"></script>
    <script type="module" src="../assets/js/connection-firebase.js"></script>

    <!-- Vendor JS Files -->
    <script src="../assets/vendor/aos/aos.js"></script>
    <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/vendor/php-email-form/validate.js"></script>
    <script src="../assets/vendor/purecounter/purecounter.js"></script>
    <script src="../assets/vendor/swiper/swiper-bundle.min.js"></script>

    <!--cdn botstrap-->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"></script>
    <!-- cdn sweet alert-->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Template Main JS File -->
    <script src="../assets/js/main.js"></script>
</body>

</html>